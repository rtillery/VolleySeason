<!DOCTYPE html PUBLIC '-//W3C//DTD HTML 4.01 Transitional//EN'>
<html lang='en'>
<head>
<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>

<title>Knights Volleyball Academy 15 Adidas Maroon (KVA15AM)</title>

<link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.2.0/css/all.css' integrity='sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ' crossorigin='anonymous'>

<script type='text/javascript' src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
<script type='text/javascript' src='tabletop.min.js'></script>
<script type='text/javascript' src='https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js'></script>
<script type='text/javascript' language='javascript' src='https://cdn.datatables.net/fixedheader/3.1.5/js/dataTables.fixedHeader.min.js'></script>

<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css'>
<link rel='stylesheet' type='text/css' href='https://cdn.datatables.net/fixedheader/3.1.2/css/fixedHeader.dataTables.min.css'>
<link rel='stylesheet' type='text/css' href='style.css'>
</head>

<body>
  <table class='teamheader'><tbody>
    <tr>
      <td>
        <table class='ourteamname'><tbody>
          <tr><td>Knights Volleyball Academy 15 Adidas Maroon (KVA15AM)</td></tr>
        </tbody></table>
      </td>
      <td>
        <table class='overall'><tbody>
        </tbody></table>
      </td>
    </tr>
  </tbody></table>
<div>
  <table id='tourneytable' class='display invisible' style='width:100%'>
    <thead>
      <tr>
        <th></th>
        <th>Tournament</th>
        <th>Dates</th>
        <th><p>Ws</p></th>
        <th><p>Ls</p></th>
        <th><p>Finish</p></th>
      </tr>
    </thead>
  </table>
</div>

<script type='text/javascript'>

  TOURNEYSHEET = "Tourneys";
  SETSHEET = "Sets";

  function winlosetie(us, them) {
    var iUs = parseInt(us);
    var iThem = parseInt(them);
    if (iUs === 0 && iThem === 0)
      colorclass = 'unplayed';
    else
      colorclass = (iUs > iThem) ? 'win' : ((iUs < iThem) ? 'lose' : 'tie');
    return colorclass;
  }

  function format(d) {
    sets = setsheet.elements;
    var setarray = $.grep(sets, function(e) { return e.Tournament == d["Tournament"]; });
    var detailtable = "<table class='sets' cellpadding='5' cellspacing='0' border='0' style='padding-left:50px;'>";
    var daterounds = [];
    $.each(setarray, function(index, row) {
      var setdate = row["Date"];
      var setround = row["Round"];
      var dateround = setdate + setround;
      if ($.inArray(dateround, daterounds) < 0)
          daterounds.push(dateround);
    });
    $.each(daterounds, function(index, dtrd) {
      var dtrdsetarray = $.grep(sets, function(e) { return dtrd == e.Date + e.Round; });
      detailtable += "<tr><td class='dt-right round'>" + dtrdsetarray[0]["Date"] + "</td><td class='round'>" + dtrdsetarray[0]["Round"] + "</td><td class='heading'>Us</td><td><p class='cond heading'>Them</p></td>";
      var evenopp = true;
      var lastopponent = "";
      $.each(dtrdsetarray, function(index, value) {
        var opponent = value['Opponent'];
        if (opponent !== lastopponent) {
          evenopp = !evenopp;
          lastopponent = opponent;
        }
        var tdwlt = "<td class='" + winlosetie(value["Us"], value["Them"]) + " dt-center'>";
        detailtable += "<tr class='set " + (evenopp ? "evenopp" : "oddopp") + "'>" +
                         "<td colspan='2'><p>" + opponent + "</p></td>" +
                         tdwlt + value['Us'] + "</td>" +
                         tdwlt + value['Them'] + "</td>" +
                       "</tr>";
      });
    });
    detailtable += "<tr><td class='heading dt-right'>Points:</td><td>" + d["Points"] + "</tr>";
    detailtable += "</table>";
    return detailtable;
  }

  $(document).ready(function() {
    $('body').prepend("<i class='fas fa-volleyball-ball fa-spin loading' style='font-size:25vmin'></i>");

    Tabletop.init({
      key: 'https://docs.google.com/spreadsheets/d/1wXLmCIAl1-0Z25OVh0zf2TtauGjt0xGY0MJRhTJBf-k/pubhtml',
      callback: showDataTable,
      wanted: [ SETSHEET, TOURNEYSHEET ]
    });
  });

  function showDataTable(dataarray, tabletop) {

    var order = {
      'Nov': 0,
      'Dec': 30,
      'Jan': 61,
      'Feb': 92,
      'Mar': 121,
      'Apr': 152,
      'May': 182,
      'Jun': 213,
      'Jul': 243
    };

    $.fn.dataTable.ext.type.order['custom2-pre'] = function ( data ) {
      month = data.substr(0, 3);
      var pat = /\s*\d+/g;
      day = pat.exec(data);
      val = parseInt(order[month], 10) + parseInt(day, 10);
      return val;
    };

    $('#tourneytable').removeClass('invisible');
    $('.loading').remove();

    tourneysheet = dataarray[TOURNEYSHEET];
    setsheet = dataarray[SETSHEET];
    results = tourneysheet.elements;
    overall = results[0];

//        $('.overall').append("<tr>" +
//                                     "<td>Overall:</td>" +
//                                     "<td>" + overall.OverallPercent + "</td>" +
//                                     "<td>(" + overall.OverallWins + "&nbsp-&nbsp" + overall.OverallLosses + ")</td>" +
//                                 "</tr>");

    var table = $('#tourneytable').DataTable({
      'data': results,
      fixedColumns: {
        'heightMatch': 'none'
      },
      columns: [
        { 'className': 'details-control',
          'orderable': false,
          'data': null,
          'defaultContent': '',
          'render': function () {
              return "<i class='fa fa-plus-square' aria-hidden='true'></i>";
          },
          'width':'6mm' },
        { 'data': 'Tournament' },
        { 'data': 'Dates',
          'width': '36mm',
          'className': 'dt-center',
          'type': 'custom2' },
        { 'data': 'Wins',
          'width': '9mm',
          'className': 'dt-center' },
        { 'data': 'Losses',
          'width': '9mm',
          'className': 'dt-center' },
        { 'data': null,
          'defaultContent': '',
          'width': '18mm',
          'className': 'dt-center' },
      ],
      paging: false,
      searching: false,
      fixedHeader: {
        header: true,
        footer: false
      },
      rowCallback: function(row, data, index) {
        var tester = $(row).find('td:eq(3)');
        if (tester.hasClass('win') || tester.hasClass('lose') || tester.hasClass('tie') || tester.hasClass('unplayed'))
          return;
        $(row).find('td:eq(1)').wrapInner("<p></p>");
        $(row).find('td:eq(2)').wrapInner("<p></p>");
        $(row).find('td:eq(3)').addClass(winlosetie(data["Wins"], data["Losses"]));
        $(row).find('td:eq(4)').addClass(winlosetie(data["Wins"], data["Losses"]));
        var item = $(row).find('td:eq(5)');
        item[0].innerHTML = data["Finish"] + " / " + data["Teams"];
        item.wrapInner("<p></p>");
        $(row).find('td:eq(6)').wrapInner("<p></p>");
      },
      'order': [[2, 'asc']]
    });

    $('body').css('cursor', 'default');

    // Add event listener for opening and closing details
    $('#tourneytable tbody').on('click', 'td.details-control', function () {
      var tr = $(this).closest('tr');
      var row = table.row( tr );

      if ( row.child.isShown() ) {
        // This row is already open - close it
        row.child.hide();
        tr.removeClass('shown');
      }
      else {
        // Open this row
        row.child( format(row.data()) ).show();
        tr.addClass('shown');
      }
    });
  }

</script>

</body>
</html>
